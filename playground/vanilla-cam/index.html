<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Frame Processing with Web Worker</title>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia && window.Worker && 'OffscreenCanvas' in window) {
                let video = document.createElement('video');
                const worker = new Worker('worker.js');

                video.setAttribute('autoplay', '');
                video.setAttribute('muted', '');
                document.body.appendChild(video);
                // List cameras and select one
                navigator.mediaDevices.enumerateDevices().then(devices => {
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    if (videoDevices.length > 0) {
                        // Example: picking the first video device found
                        // Enhance this part for providing user options to select
                        const deviceId = videoDevices[0].deviceId;
                        openCamera(deviceId);
                    }
                });
                function openCamera(deviceId) {
                    video.onloadedmetadata = () => {
                        video.play();
                        captureFrame();
                    };
                }

                function captureFrame() {
                    const offscreenCanvas = new OffscreenCanvas(video.videoWidth, video.videoHeight);
                    const ctx = offscreenCanvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);

                    // Capture high precision timestamp
                    const timestamp = performance.now();
                    console.log(`Timestamp: ${timestamp}`)

                    // Convert the frame to ImageBitmap for efficient postMessaging
                    offscreenCanvas.convertToBlob().then(blob => {
                        worker.postMessage({imageBlob: blob, timestamp: timestamp});
                    });

                    // Setup the next frame capture. Adjust as necessary for rate.
                    requestAnimationFrame(captureFrame);
                }

                worker.onmessage = function(event) {
                    // Handle messages from your worker, e.g., processed frame data
                };
            } else {
                console.log('Browser does not support required features.');
            }
        });
    </script>
</head>
<body>
    <!-- Video element is created but not added to the body, as it's hidden -->
</body>
</html>
